# Микросервисы на Go
### Конструирование Программного обеспечения. ДЗ № 4.
### Выполнил Киселев Иван БПИ217

### Описание программы:
Программа представляет собой два микросервиса с транспортом реализованным с помощью gRPC: user-svc и order-svc

А также API-gateway, для "общения" с клиентом. Обмен данными с клиентом идет через протокол http

### Требования к программе (ТЗ):
Все требования реализованы (на 10), включая согласованные небольшие изменения:
- Таблица сессий убрана, так как было решено записывать дату просрочки токена в его тело, а также в масштабе задания сессии не играли важную роль
- Вместо целочисленных id было принято решение использовать стандарт UUID
- Регистрация была реализована используя стандарт OAuth2 и из Google Sign-In аутентификации

Далее описана сама реализация

### Инструменты, методики и технологический стек:
- Задание реализовано на языке Go (Golang 1.19)
- Программы использует систему gRPC, для обмена данными между сервисами. Используя бинарный протокол передачи данных -- Protocol Buffers (protobuf), что уменьшает объемы передаваемых данных и принято в разработке микросервисов на Go.
- Программы работают с базой данных PostreSQL, запросами не используя ORM фреймворки.
- Микросервисы реализованы придерживаясь чистой архитектуры, а также структуры проекта и важным паттернам, принятых по крайней мере в Go 
- Работа с jwt токенами
- Авторизация с использованием стандарта Oauth2
- В работе с PostreSQL были использованы транзакции, триггеры, а также нужные constraints 
- Написана документация с помощью Postman, содержащая примеры на все запросы, а также их описание
- Большой объем кода. Включая сгенерированные файлы: более 10к строк

### Некоторые пояснения:
Документация находится в одной папке с README.md. Там описаны действия для пользования (в документации коллекции). Данную коллекцию API.postman_collection.json можно импортировать в Postman desktop

Авторизация в обмен на id_token из Google Sing-In возвращает корректный jwt токен для пользователя.
Как правило, id_token кидает клиентская часть приложения, например мобильная, так как пользователь именно там проходит аутентификацию. Однако
  id_token можно получить на сайте для тестирования от Google: https://developers.google.com/oauthplayground/

Чтобы получить id_token надо найти Google OAuth2 API v2 и выбрать scope https://www.googleapis.com/auth/userinfo.email

Затем нажать Authorize APIs. Затем Exchange Authorization code for tokens. И в ответе будет поле "id_token" содержание которого нужно скопировать и вставить в запрос авторизации к данной программе.

### Строение репозитория программы:
Микросервис (на примере ./order-svc):
```
├── cmd/app   // точка входа в приложение
├── configs/config.yml // файлы конфигураций
├── internal // директория не предполгающая экспорт
│  ├── core   // domain модели (DTO, ошибки, использующиеся везде)
│  ├── transport/grpc   // транспортный слой (реализован grpc)
│  ├── repository   // слой репозитория (к бд/облаку)
│  │   ├── dao  // структуры (модели) для репозитория
│  ├── service   // бизнес логика
├── pkg/pb // pkg директория из которой допускается экспорт
│  ./ order.proto // файл для описания protobuf запросов и ответов
│  ./ order.pb.go // генерирумый файлы для protobuf (pb)
│  ./ order_grpc.pb.go // генерирумый файлы для protobuf и grpc
├── schema   // файлы миграций  
```

Api-gateway:
```
├── cmd/app // точка входа в приложение
├── configs // файлы конфигураций
├── core    // domain модели (DTO, ошибки, использующиеся везде)
├── http_tools  // общие методы и контанты для http транспорта
├── user    //  реализации работы с микросервисом пользователей
│  ├── pkg/pb   // директория c protobuf файлами
├── order   //  реализации работы с микросервисом заказов
│  ├── pkg/pb // директория c protobuf файлами
├── pkg // pkg директория из которой допускается экспорт
```

### Запуск программы через docker-compose:

Предполагается запуск на следующих портах:
> gateway: 8081
>
> user-svc: 8082
>
> order-svc: 8083

Поэтому к приложению надо будет обращаться по http://localhost:8081/...

Все виды запросов описаны и прокомментированы с примерами в Postman документации

**Для того чтобы запустить микросервисы через docker-compose:**

- убедится что docker-compose.уml файл соответствует ожидаемым параметрам запуска (при изменении docker-compose вероятно нужно будет менять конфиги)
- Запустить его
```shell
docker compose up --build
```
- Прогнать миграции
```shell
migrate -path ./user-svc/schema -database 'postgres://postgres:password@localhost:5433/postgres?sslmode=disable' up
```
```shell
migrate -path ./order-svc/schema -database 'postgres://postgres:password@localhost:5434/postgres?sslmode=disable' up
```

Только после этого можно будет обращаться к api-gateway 

### Заупуск программы локально (не актуально):

В конфигах предполагается запуск локально на следующих портах:
> gateway: 8081
> 
> user-svc: 8082
> 
> order-svc: 8083

**Для того чтобы запустить микросервис User-svc:**

- убедится что конфиг файл соответствует ожидаемым параметрам запуска
```yaml
port: ":8082"

db:
  host: "localhost"
  port: "5433"
  username: "postgres"
  password: "password"
  dbname: "postgres"
  sslmode: "disable"
```
(другие параметры не предполагается менять)

Далее в из директории go-mvc-example
- Создать базу данных для микросервиса (я делаю это через докер с образом postgres)
```shell
docker run --name=user_db -e POSTGRES_PASSWORD='password'  -p 5433:5432 -d postgres
```
- Прогнать миграцию
```shell
migrate -path ./user-svc/schema -database 'postgres://postgres:password@localhost:5433/postgres?sslmode=disable' up
```
- Запустить микросервис
```shell
./user-svc/build.exe
```

**Для того чтобы запустить микросервис Order-svc:**

- убедится что конфиг файл соответствует ожидаемым параметрам запуска
```yaml
port: ":8083"

db:
  host: "localhost"
  port: "5434"
  username: "postgres"
  password: "password"
  dbname: "postgres"
  sslmode: "disable"
```


Далее в из директории go-mvc-example
- Создать базу данных для микросервиса (я делаю это через докер с образом postgres)
```shell
docker run --name=order_db -e POSTGRES_PASSWORD='password'  -p 5434:5432 -d postgres
```
- Прогнать миграцию
```shell
migrate -path ./order-svc/schema -database 'postgres://postgres:password@localhost:5434/postgres?sslmode=disable' up
```
- Запустить микросервис
```shell
./order-svc/build.exe
```

**Для того, чтобы запустить API-Gateway:**

- убедится что конфиг файл соответствует ожидаемым параметрам запуска
```yaml
port: "8081"
```

```dotenv
PORT=:8001
USER_SVC_URL=localhost:8082
ORDER_SVC_URL=localhost:8083
```
Далее в из директории go-mvc-example
- Запустить API gateway
```shell
./api-gateway/build.exe
```

### Дополнительно:
~~Есть шанс, что я запущу программу на VPS с обращениями по адрессу http://134.0.119.220:8081/...~~ (upd: кончилась аренда, так что отмена)

Желаю приятно вам провести лето, осталось совсем чуть-чуть (хотя впереди еще много работы хех)!
